---
title: "STAT 429 Project: US Housing Market"
author: "Kunal Bhardwaj"
date: "2024-02-23"
output: html_document
---

```{r message=FALSE}
library(readr)
MSPUS <- read_csv("Data/MSPUS.csv",
                  col_types = cols(DATE = col_date(format = "%Y-%m-%d")))

MSACSR <- read_csv("Data/MSACSR.csv",
                   col_types = cols(DATE = col_date(format = "%Y-%m-%d")))

HOUST <- read_csv("Data/HOUST.csv",
                  col_types = cols(DATE = col_date(format = "%Y-%m-%d")))

MORTGAGE30US <- read_csv("Data/MORTGAGE30US.csv",
                         col_types = cols(DATE = col_date(format = "%Y-%m-%d")))
```


```{r message=FALSE}
library(astsa)
library(ggplot2)
library(ggfortify)
library(fpp2)
library(imputeTS) # For handling missing values by imputation
library(tseries) # To carry out ADF & KPSS Tests
library(lmtest) # To carry out BP-Test

mspus.ts <- ts(MSPUS$MSPUS, start = 1963, frequency = 4) # Select 2nd column from MSPUS
msacsr.ts <- ts(MSACSR$MSACSR, start = 1963, frequency = 12) # Select 2nd column from MSACSR
houst.ts <- ts(HOUST$HOUST, start = 1959, frequency = 12) # Select 2nd column from HOUST

# MORTGAGE30US contains missing values. They are occupied by "."
# They will be imputed by replacing with NA follwed by linear interpolation
MORTGAGE30US$MORTGAGE30US <- ifelse(MORTGAGE30US$MORTGAGE30US == ".",
                                    NA, MORTGAGE30US$MORTGAGE30US)
MORTGAGE30US$MORTGAGE30US <- na_interpolation(as.numeric(MORTGAGE30US$MORTGAGE30US))
# Select 2nd column from MORTGAGE30US. The first value on Apr 2 1971 falls on the 14th week
mortgage.ts <- ts(MORTGAGE30US$MORTGAGE30US, start = c(1971, 14) , frequency = 52)

par(mfrow=c(4,1))
tsplot(mspus.ts, col ="darkorange",
       main = "Median Sales Price of Houses Sold for the United States",
       ylab = "USD")
tsplot(msacsr.ts, col ="mediumblue",
       main = "Monthly Supply of New Houses in the United States",
       ylab = "Month's Supply")
tsplot(houst.ts, col ="limegreen",
       main = "New Privately-Owned Housing Units Started : Total Units",
       ylab = "Thousands of Units")
tsplot(mortgage.ts, col ="grey",
       main = "30-Year Fixed Rate Mortgage Average in the United States", ylab = "Percent")
```


From the plot of Median Sales Price of Houses Sold, we can see that there exists an obvious trend in the data. Therefore de-trending needs to be carried out to achieve stationarity.
```{r warning=FALSE}
# De-trending MSPUS Time Series
mspus_trend <- lm(mspus.ts ~ time(mspus.ts))
#summary(mspus_trend)

par(mfrow=c(2,1))
tsplot(mspus.ts, col ="darkorange",
       main = "Median Sales Price of Houses Sold for the United States",
       ylab = "USD")
abline(mspus_trend, col = "darkblue")
tsplot(resid(mspus_trend), col ="darkorange",
       main = "[De-trended] Median Sales Price of Houses Sold for the United States")

# check for Stationarity using (Augmented) Dickey-Fuller Test and KPSS Test
adf.test(resid(mspus_trend))
kpss.test(resid(mspus_trend))
```

Both ADF and KPSS tests conclude that the MSPUS de-trended series is non-stationary.
We will try differencing to achieve stationarity.

```{r warning=FALSE}
# Differencing MSPUS Time Series
tsplot(diff(mspus.ts))

adf.test(diff(mspus.ts))
kpss.test(diff(mspus.ts))
```

The series passes both these tests of stationarity. But the series exhibits an obvious heteroscedasticity where higher levels are associated with higher variation. A log-transformation is recommended.

```{r}
mspus.rs_log <- log(mspus.ts)
tsplot(diff(mspus.rs_log), main = "Return : Differencing after log transformation") # Return (Differencing after log transformation)
```

The BP Test for homoscedasticity fails for MSPUS, log(MSPUS), diff(MSPUS), diff(MSPUS, lag =4),  diff(log(MSPUS)), and diff(resid(mspus_trend)). Will try differencing with a lag of 4 after log transformation.

```{r warning=FALSE}
# Differencing with a lag of 4 after taking log
tsplot(diff(log(mspus.ts), lag = 4))
adf.test(diff(log(mspus.ts), lag = 4))
kpss.test(diff(log(mspus.ts), lag = 4))
bptest(lm(diff(log(mspus.ts), lag = 4) ~ time(diff(log(mspus.ts), lag = 4))))

# Log transformation of the differencing at lag 4 is not carried out because it produces NaNs
```

Differencing with a lag of 4 after taking log passes ADF Test & KPSS tests of stationarity and BP-Test for homoscedasticity. Taking lag = 4 insted of the default lag = 1 while differencing seems to have helped in removing the seasonality associated with the MSPUS series.

```{r}
par(mfrow=c(3,2))
tsplot(log(mspus.ts), main = "Log Transformation") # Log Transformation
tsplot(diff(mspus.ts), main = "Differencing") # Differencing
tsplot(diff(log(mspus.ts)), main = "Return : Differencing after log transformation") # Return (Differencing after log transformation)
tsplot(diff(residuals(mspus_trend)), main = "Differencing after de-trending") # Differencing after de-trending
tsplot(diff(mspus.ts, lag = 4), main = "Differencing with lag = 4 (Annual)") # Differencing with a lag of 4
tsplot(diff(log(mspus.ts), lag = 4), main = "Differencing with lag = 4 after log transformation")
```

```{r}
# ACF of transformed outcome variable
acf(diff(log(mspus.ts), lag = 4), lag.max = 50)
```


```{r}
msacsr_trend <- lm(msacsr.ts ~ time(msacsr.ts))
summary(msacsr_trend)
tsplot(msacsr.ts, col ="mediumblue",
       main = "Monthly Supply of New Houses in the United States",
       ylab = "Month's Supply")
abline(msacsr_trend, col = "red")
tsplot(resid(msacsr_trend), col = "darkblue",
       main = "[De-trended] Monthly Supply of New Houses in the United States")
adf.test(msacsr.ts)
kpss.test(msacsr.ts)
bptest(lm(msacsr.ts ~ time(msacsr.ts)))
bptest(lm(log(msacsr.ts) ~ time(msacsr.ts)))
```


